---
title: "R Notebook"
author: "Benjamin Leyton"
date: "6-11-2021"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## CPCoA Analysis

This Rmarkdown document aims to show the methodology used in this study.


## Visualizacion con BIC

BIC is a web platform that makes the R code available for your graphics. We use the code to generate the CPCoA graphs, also known as CAP. This analysis was tested with a PERMANOVA test.

Important: The patterns shown below are generated by the presence and abundance of IS transposases. This information was taken to a Euclidean distance matrix. The CPCoA graph was built in relation to the lineages, then the ARG number and the geographic location were colored through the different lineages.

```{r pressure, echo=TRUE}

if (TRUE) {
	suppressMessages(library("reshape2"))
	suppressMessages(library("ggplot2"))
	suppressMessages(library("vegan"))
	suppressMessages(library("digest"))
	suppressMessages(library("ggrepel"))
	suppressMessages(library("ggpubr"))
} else {

	site="https://mirrors.tuna.tsinghua.edu.cn/CRAN"
	
	package_list = c("reshape2","ggplot2","vegan")

	for(p in package_list){
	  if(!suppressWarnings(suppressMessages(require(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))){
		install.packages(p, repos=site)
		suppressWarnings(suppressMessages(library(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))
	  }
	}


	package_list = c("digest","ggrepel")
	for(p in package_list){
	  if(!suppressWarnings(suppressMessages(require(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))){
		source("https://bioconductor.org/biocLite.R")
		biocLite(p)
		suppressWarnings(suppressMessages(library(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))
	  }
	}


	#Install Github common packages
	#Parameter analysis, data transformation, drawing and development package installation
	package_list = c("kassambara/ggpubr")
	for(p in package_list){
	  q=unlist(strsplit(p,split = "/"))[2]
	  if(!suppressWarnings(suppressMessages(require(q, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))){
		install_github(p)
		suppressWarnings(suppressMessages(library(q, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)))
	  }
	}
}
  


# INPUT DISTANCE MATRIX
otutab = read.table("./euclidean_matrix.txt", header=T, row.names=1, sep="\t", quote="", comment="") 

# INPUT PHENODATA
design = read.table("./phenodata_lineages.txt", header=T, row.names= NULL, sep="\t", quote="", comment="") 
rownames(design) <- design[,1]


# Extract the sample group information, the default is genotype can be specified

sampFile = as.data.frame(design[,"lineage"],row.names = row.names(design))
colnames(sampFile)[1] = "lineage"
sampFile$sample=row.names(design)


# Data filtering, filtering common in the two files

idx = rownames(sampFile) %in% colnames(otutab) # match design with alpha
sampFile = sampFile[idx,]
otutab = otutab[,rownames(sampFile)] 


#Statistics and Graphics Statistics and Graphics

# Extract the main results in CCA
variability_table = function(cca){
  chi = c(cca$tot.chi, cca$CCA$tot.chi, cca$CA$tot.chi)
  variability_table = cbind(chi, chi/chi[1])
  colnames(variability_table) = c("inertia", "proportion")
  rownames(variability_table) = c("total", "constrained", "unconstrained")
  return(variability_table)
}

#t(otutab)
#sampFile
# Constrained analysis ISs table (otutab) by lineage
capscale.gen = capscale(t(otutab) ~ lineage, data=sampFile, add=F, sqrt.dist=T, distance="euclidean") 
capscale.gen

# ANOVA-like permutation analysis
perm_anova.gen = anova.cca(capscale.gen, permutations = 10000, parallel = 9)


# generate variability tables and calculate confidence intervals for the variance
var_tbl.gen = variability_table(capscale.gen)
eig = capscale.gen$CCA$eig
variance = var_tbl.gen["constrained", "proportion"]
p.val = perm_anova.gen[1, 4]

#capscale.gen
capscale.gen$CCA$wa
# extract the weighted average (sample) scores
points = capscale.gen$CCA$wa[, 1:2]

points = as.data.frame(points)
colnames(points) = c("x","y")

points = cbind(points, design[rownames(points), ])

#print(points)


shape_order <- c()

if (length(shape_order) > 1) {
	points$lineage <- factor(points$lineage, levels=shape_order, ordered=T)
}

color_order <- c()

if (length(color_order) > 1) {
	points$lineage <- factor(points$lineage, levels=color_order, ordered=T)
}

color_v <- c()

if ("lineage" != "c_t_c_t0304") {
	shape_level <- length(unique(points$lineage))
	shapes = (1:shape_level)%%30
}


```



## Lineages groups

The significance is completely arbitrary, it is set at 0.05 by convention, however it is not the most accurate, the significance of the tests varies with the different analyzes and must be adapted. For our analyzes we followed the Bonferroni correction to establish a significance limit
~ alpha / m, where m is the number of variables
In this study we used a matrix of presence and abundance of 323 groups of IS present in C. striatum. In this way we establish a confidence limit of 0.05 / 323 = 0.0001548, under this alpha ', the distance of the groups is significant.

```{r}
# plot CPCo 1 and 2
p = ggplot(points, aes(x=x, y=y,color=lineage,group=lineage)) + geom_point(alpha=1) +coord_fixed() +
  labs(x=paste("CPCoA 1 (", format(100 * eig[1] / sum(eig), digits=4), "%)", sep=""),
       y=paste("CPCoA 2 (", format(100 * eig[2] / sum(eig), digits=4), "%)", sep="")) + 
  ggtitle(paste(format(100 * variance, digits=4), " % of variance; p=",format(p.val, digits=10),sep="")) + 
  theme_classic()+ 
  stat_ellipse(level=0.68, na.rm=TRUE)

if ("ct___" != "ct___"){
	p <- p + aes(size=ct___)
}


if (length(color_v) >= 2) {
	if (is.numeric(points$lineage)){
		p <- p + scale_colour_gradient(low=color_v[1], high=color_v[2], name="lineage")
	}else {
		p <- p + scale_color_manual(values=color_v)
	}
}

if ("lineage" != "c_t_c_t0304") {
	p <- p + aes(shape=lineage)
	if ( shape_level > 6) {
		p <- p + scale_shape_manual(values=shapes)
	}
}

if (FALSE) {
	if ("" != "") {
		p <- p + geom_text_repel(label=paste(rownames(points)), 
			show.legend=F, size=)
	} else {
		p <- p + geom_text_repel(label=paste(rownames(points)), 
			show.legend=F)
	}
}
outputprefix = "lineages"
ggsave(filename = paste0(outputprefix, '_cpcoa.pdf'),p)
p
```
We then find that our CPCoA analyzes are significant (p-value < 0,0001548).

## Amount of ARG in C. striatum lineages



```{r, echo=TRUE}

arg = read.table("./phenodata_ARG.txt", header=T, row.names= NULL, sep="\t", quote="", comment="") 

points$arg<-arg$No_ARG


pq = ggplot(points, aes(x=x, y=y,color=arg,group=lineage)) + geom_point(alpha=1) +coord_fixed() +
  labs(x=paste("CPCoA 1 (", format(100 * eig[1] / sum(eig), digits=4), "%)", sep=""),
       y=paste("CPCoA 2 (", format(100 * eig[2] / sum(eig), digits=4), "%)", sep="")) + 
  ggtitle(paste(format(100 * variance, digits=4), " % of variance; p=",format(p.val, digits=10),sep="")) + 
  theme_classic()+ 
  stat_ellipse(level=0.68, na.rm=TRUE)

if ("ct___" != "ct___"){
  pq <- pq + aes(size=ct___)
}


if (length(color_v) >= 2) {
  if (is.numeric(points$lineage)){
    pq <- pq + scale_colour_gradient(low=color_v[1], high=color_v[2], name="lineage")
  }else {
    pq <- pq + scale_color_manual(values=color_v)
  }
}

if ("lineage" != "c_t_c_t0304") {
  pq <- pq + aes(shape=lineage)
  if ( shape_level > 6) {
    pq <- pq + scale_shape_manual(values=shapes)
  }
}

if (FALSE) {
  if ("" != "") {
    pq <- pq + geom_text_repel(label=paste(rownames(points)), 
                             show.legend=F, size=)
  } else {
    pq <- pq + geom_text_repel(label=paste(rownames(points)), 
                             show.legend=F)
  }
}

arg_final<-pq+ scale_colour_gradientn(colours = terrain.colors(20))

outputprefix = "arg_in_lineages"
ggsave(filename = paste0(outputprefix, '_cpcoa.pdf'),arg_final)
arg_final

```

## Geographical distribution of the C. striatum lineages

```{r, echo=TRUE}
location = read.table("./phenodata_Location.txt", header=T, row.names= NULL, sep="\t", quote="", comment="")

points$location<-location$Location


pqp = ggplot(points, aes(x=x, y=y,color=location,group=lineage)) + geom_point(alpha=1) +coord_fixed() +
  labs(x=paste("CPCoA 1 (", format(100 * eig[1] / sum(eig), digits=4), "%)", sep=""),
       y=paste("CPCoA 2 (", format(100 * eig[2] / sum(eig), digits=4), "%)", sep="")) + 
  ggtitle(paste(format(100 * variance, digits=4), " % of variance; p=",format(p.val, digits=10),sep="")) + 
  theme_classic()+ 
  stat_ellipse(level=0.68, na.rm=TRUE)

if ("ct___" != "ct___"){
  pqp <- pqp + aes(size=ct___)
}


if (length(color_v) >= 2) {
  if (is.numeric(points$lineage)){
    pqp <- pqp + scale_colour_gradient(low=color_v[1], high=color_v[2], name="lineage")
  }else {
    pqp <- pqp + scale_color_manual(values=color_v)
  }
}

if ("lineage" != "c_t_c_t0304") {
  pqp <- pqp + aes(shape=lineage)
  if ( shape_level > 6) {
    pqp <- pqp + scale_shape_manual(values=shapes)
  }
}

if (FALSE) {
  if ("" != "") {
    pqp <- pqp + geom_text_repel(label=paste(rownames(points)), 
                               show.legend=F, size=)
  } else {
    pqp <- pqp + geom_text_repel(label=paste(rownames(points)), 
                               show.legend=F)
  }
}
pqp
outputprefix = "Location_of_lineages"
ggsave(filename = paste0(outputprefix, '_cpcoa.pdf'),pqp)
```